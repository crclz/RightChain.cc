# 通过命令行工具保护仓库里的文章

<!-- RightChain.cc -->

当选择使用浏览器访问网站的方式，用户可以手动填写自己的文章信息，并导出和版权相关的信息。

但是，如果文件数量变多，文件修改更加频繁，那么浏览器的方式就显得笨拙。这时，我们可以通过命令行工具来自动化这一流程。

## 优势
- 多文件，多版本
- 自动化，省事
- 与git仓库的理念一致，版权信息跟随仓库，无需存放于其他地方

接下来，本文将简单地介绍命令行工具的使用流程。

## 前提
<!-- - 你已经注册了账号，并且记住了账号和密码。 -->
- 电脑已经安装python环境。python>=3.7
- 了解git的基本使用方法

## 安装命令行工具

**通过pip安装**

命令行工具是开源的，源代码就在本仓库的`src`目录下。

有时，pypi镜像源可能会出现同步延迟的问题（例如TUNA）。用户可以通过下面这条命令，从官方pypi源进行安装。

`pip install rightchain -U -i https://pypi.org/simple/`


**测试安装**

用户可以运行下面这一条命令来测试安装是否成功。如果成功，那么就会有相应的命令行提示。

`python -m rightchain` 

另外 `python -m rightchain` 可以使用 `rccc` 简化。 (RightChain.cc 的简写)

**命令行工具说明**

用户可以通过`rccc`来运行命令行工具，效果等价于`python -m rightchain`。

rccc支持的命令如下。每一条命令具体的意义和用法，会在后文详细讲解。

<!-- - test-login：测试登录 -->
- create-index：创建索引文件
- push-index：上传索引文件
- index：create-index + push-index
- fetch：从服务器下载打包后的信息

简单来说，我们为文章进行登记的流程是这样的：

首先进行文章写作，然后 `create-index` + `push-index`，将索引信息发送到服务器。之后，等待服务器打包完成后（平均6h），然后运行`fetch`，将版权相关的信息下载到本地。最后git-commit，让版权相关的信息跟随git仓库。

## 选择需要登记的仓库

第一步是找一个git仓库（文件夹）。仓库里面是你的文章或者其他知识成果。

你可以从已有的git仓库开始，也可以从一个新的git仓库开始。请确保git仓库里面至少有一个提交。

通过以下命令来检查git仓库里面至少有一个提交：

`git log --pretty=format:%H -1`

这条命令的输出应当是和下面相似的字符串：

`d8f4b821395cb47f65e6a9cd4c284d104b5380c0`

## 创建索引文件

为了记录仓库里文件的哈希值，我们需要创建索引文件。在仓库根目录打开控制台，运行下面这一条命令，就可以创建索引文件。

`rccc create-index`

接下来，就可以在`copyrightstore/index.json`找到索引文件。下面是索引文件的一个样本。

简单来说，索引文件存在的意义，是减少需要向服务器传输的数据的量。（在登记时，索引文件的内容不会被上传，只会上传索引文件的sha256。当需要证明版权的时候，索引文件、待证明文件和从服务器导出的版权信息需要被公开。）

```json
{
    "previousCommit": "d8f4b821395cb47f65e6a9cd4c284d104b5380c0",
    "copyrightInfo": null,
    "data": [
        {
            "name": "./2.md",
            "hash": "2f521e2a7d0bd812cbc035f4ed6806eb8d851793b04ba147e8f66b72f5d1f20f"
        },
        {
            "name": "./math.md",
            "hash": "e354cf7065827bba69ede716358a3c82b37e89d8ec1a86e35b8a8d84ba873b0b"
        },
        {
            "name": "./readme.md",
            "hash": "3683bf66c53f75e8d137d45b04a94a5532b74edd644f186ca262135a08863b49"
        },
        {
            "name": "./other/a.txt",
            "hash": "df62d1a12770d5ae0e5a57ec81281529af37158c23918737061eac2ebf8b24e7"
        },
        {
            "name": "./other/b.md",
            "hash": "9834876dcfb05cb167a5c24953eba58c4ac89b1adf57f28f2f9d09af107ee8f0"
        }
    ]
}
```

接下来，我们对索引文件的样本进行一些说明。

**previousCommit**

previousCommit代表“前一个提交ID”。用git的术语来说，就是`HEAD`指针。（不明白也没关系）。

为什么要记录previousCommit？因为我们要记录这个索引文件（index.json）对应的是哪一版本的仓库。如果你偶尔进行登记，那么旧的index.json就会和新的仓库共存，所以我们需要将index.json和提交ID对应起来。由于当前的commit的ID需要提交后才能够知道，所以，rccc使用“上一个提交ID”来解决。

**copyrightInfo**

索引文件中应当具备能够表明作者身份的信息。如果没有这些信息，那么用户就可能面临“能够证明文章发布时间，但是证明不了作者是我”这种情况。

为了让索引文件附带copyright info，我们需要在仓库的根目录中创建`copyright-info`文件，在里面填入个人身份的相关信息：

```
本仓库的内容由 小明 原创。
小明@xxxx.edu.cn
510122100001016666
```

在上一个例子中，我们使用身份证号宣示对作品的绝对主权。当然，rccc不会上传索引文件，只会上传索引文件的sha256值，所以不用担心隐私泄露的问题。

然后，我们再运行一次`rccc create-index`。这样，作者信息就会被附带在索引文件中了：

```json
{
    "previousCommit": "d8f4b821395cb47f65e6a9cd4c284d104b5380c0",
    "copyrightInfo": "本仓库的内容由 小明 原创。\n小明@xxxx.edu.cn\n510122100001016666"
}
```

**哪些文件将会被包含？**

rccc命令行工具会根据仓库根目录下的`.gitignore`文件进行文件忽略。暂时不支持非根目录的`.gitignore`。

此外，用户可以在仓库根目录创建`.rightignore`文件进行扩展。（right ignore）


## 上传索引文件

<!-- 我们需要注册一个账号来进行与服务器的交互。注册完账号后，要牢记用户名和密码。

**设置用户名、密码**

命令行工具通过环境变量读取用户名和密码。所以，我们需要修改环境变量`RIGHT_USERNAME`（用户名）、`RIGHT_PASSWORD`（密码）。设置环境变量后，别忘了重启终端以更新环境变量。

请运行以下命令以检查能否顺利登录：

`rccc test-login` -->

**上传**

运行以下命令，我们可以将索引文件在服务端登记：

`rccc push-index`

我们发现，我们的`copyrightstore/waiting`目录中多了一个文件，文件名是 previousCommitID ，内容是服务器上的记录的ID，为后面的`rccc fetch`命令所用。

## 提交git更改

在`create-index` 和 `push-index`后，用户不应当修改任何文章，而是应当立即进行git-commit，来让索引文件得以对应当前版本的文章。

## 下载版权信息

网站每隔12小时会进行一次打包，将必要信息登记在区块链上。也就是说，每12小时，新的文件会获得版权信息。

同样地，我们希望将版权信息保存于git仓库中，让版权信息伴随我们的仓库。

在等待网站打包完成后，通过运行以下命令，我们得以将版权信息保存在仓库中：

`rccc fetch`

程序将遍历`copyrightstore/waiting`中的待下载的记录，向服务器发送请求。对于`waiting`中的每一条记录，如果服务器的响应表明它已经打包好了，那么响应中的必要数据就会被储存在`copyrightstore/packaged`中。

服务器的响应具体有什么意义： [延伸阅读](./validate.md)

## FAQ
Q：建立索引文件有什么优势？为何不将整个仓库一同打包？\
A：建立索引文件，代表我们以“文件”为最小单位。当需要证明的时候，我们仅仅需要公开索引文件和目标文件，而不必公开整个仓库。如果以仓库为单位，会有仓库太大、其他文件需要保密等问题。

另外，在验证版权时，索引文件中的文件名可能不适合出示给他人或机构。如果您有文件名保密这一特性的需求，请在ISSUE中提出，以纳入开发计划。

Q：为什么我文件的sha256计算有差异？\
A：文本文件会有换行CRLF/LF的差异。rccc不会去进行相关的转换，而是直接计算文件的sha256。如果更换操作系统，或者是更改git的某项设置，就会出现不一致现象。但是，无需过度担心。因为在证明的时候，只需计算LF版本、CRLF版本的sha256，总有一个符合。
