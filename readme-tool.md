# 通过命令行工具保护仓库里的文章


## 准备工作

### 环境要求
- 电脑已经安装python环境。python>=3.7
- 了解git的基本使用方法

### 安装命令行工具

**通过pip安装**

`pip install rightchain -U -i https://pypi.org/simple/`

有时，pypi镜像源可能会出现同步延迟的问题（例如TUNA）。用户可以通过下面这条命令，从官方pypi源进行安装。

命令行工具是开源的，源代码就在本仓库的`src`目录下。


**测试安装**

用户可以运行下面这一条命令来测试安装是否成功。如果成功，那么就会有相应的命令行提示。

`python -m rightchain` 

另外 `python -m rightchain` 可以使用 `rccc` 简化。 (RightChain.cc 的简写)

**命令行工具说明**

用户可以通过`rccc`来运行命令行工具，效果等价于`python -m rightchain`。

rccc支持的命令如下。每一条命令具体的意义和用法，会在后文详细讲解。

<!-- - test-login：测试登录 -->
- create-index：创建索引文件
- push-index：上传索引文件
- index：create-index + push-index
- fetch：从服务器下载打包后的信息


### 选择需要登记的仓库

1. 找一个git仓库（文件夹）。仓库里面是你的文章或者其他知识成果。
2. 请确保git仓库里面至少有一个提交。
3. 通过 `git log --pretty=format:%H -1` 命令来检查git仓库里面至少有一个提交

---

## 简要流程
1. 创建索引文件：运行`rccc index`，然后git commit（必须）
2. 等待打包完成：等待服务端打包、上链，最多需要等12小时，可到 rightchain.cc 查看最近打包时间
3. 运行`rccc fetch`，然后git commit（非必须）

---

## 详细流程

### 创建索引文件

运行 `rccc create-index`

接下来，就可以在`copyrightstore/index.json`找到索引文件。下面是索引文件的一个样本。

简单来说，索引文件存在的意义，是减少需要向服务器传输的数据的量。（在登记时，索引文件的内容不会被上传，只会上传索引文件的sha256。当需要证明版权的时候，索引文件、待证明文件和从服务器导出的版权信息需要被公开。）

```json
{
    "previousCommit": "aef859a0cd831055737893a194c7a3659857161f",
    "copyrightInfo": "...",
    "data": [
        "d5b861e63e7666f1ef1d75f71ef131e227ec9b3085b905eebb8b7129dfec260b",
        "e5376402a9a5caa487272cbd2f9101044c2b1dbaf376339e8f8f494240f0c3ff"
    ]
}
```

接下来，我们对索引文件的样本进行一些说明。

**previousCommit**

previousCommit代表“前一个提交ID”。用git的术语来说，就是`HEAD`指针。（不明白也没关系）。

为什么要记录previousCommit？因为我们要记录这个索引文件（index.json）对应的是哪一版本的仓库。如果你偶尔进行登记，那么旧的index.json就会和新的仓库共存，所以我们需要将index.json和提交ID对应起来。由于当前的commit的ID需要提交后才能够知道，所以，rccc使用“上一个提交ID”来解决。

**copyrightInfo**

索引文件中应当具备能够表明作者身份的信息。如果没有这些信息，那么用户就可能面临“能够证明文章发布时间，但是证明不了作者是我”这种情况。

为了让索引文件附带copyright info，我们需要在仓库的根目录中创建`copyright-info`文件，在里面填入个人身份的相关信息：

```
本仓库的内容由 小明 原创。
小明@xxxx.edu.cn
510122100001016666
```

在上一个例子中，我们使用身份证号宣示对作品的绝对主权。当然，rccc不会上传索引文件，只会上传索引文件的sha256值，所以不用担心隐私泄露的问题。

然后，我们再运行一次`rccc create-index`。这样，作者信息就会被附带在索引文件中了：

```json
{
    "previousCommit": "d8f4b821395cb47f65e6a9cd4c284d104b5380c0",
    "copyrightInfo": "本仓库的内容由 小明 原创。\n小明@xxxx.edu.cn\n510122100001016666"
}
```

**哪些文件将会被包含？**

rccc命令行工具会根据仓库根目录下的`.gitignore`文件进行文件忽略。暂时不支持非根目录的`.gitignore`。

此外，用户可以在仓库根目录创建`.rightignore`（right ignore）文件进行扩展。


### 上传索引文件

运行以下命令，我们可以将索引文件在服务端登记：

`rccc push-index`

我们发现，我们的`copyrightstore/waiting`目录中多了一个文件，文件名是 previousCommitID ，内容是服务器上的记录的ID，为后面的`rccc fetch`命令所用。

### 提交git更改

在`create-index` 和 `push-index`后，用户不应当修改任何文章，而是应当立即进行git-commit，来让索引文件得以对应当前版本的文章。

### 拉取版权信息

网站每隔12小时会进行一次打包，将必要信息登记在区块链上。也就是说，每12小时，新的文件会获得版权信息。

同样地，我们希望将版权信息保存于git仓库中，让版权信息伴随我们的仓库。

在等待网站打包完成后，通过运行以下命令，我们得以将版权信息保存在仓库中：

`rccc fetch`

程序将遍历`copyrightstore/waiting`中的待下载的记录，向服务器发送请求。对于`waiting`中的每一条记录，如果服务器的响应表明它已经打包好了，那么响应中的必要数据就会被储存在`copyrightstore/packaged`中。

服务器的响应具体有什么意义： [延伸阅读](./validate.md)

## FAQ
Q：建立索引文件有什么优势？为何不将整个仓库一同打包？\
A：建立索引文件，代表我们以“文件”为最小单位。当需要证明的时候，我们仅仅需要公开索引文件和目标文件，而不必公开整个仓库。如果以仓库为单位，会有仓库太大、其他文件需要保密等问题。

另外，在验证版权时，索引文件中的文件名可能不适合出示给他人或机构。如果您有文件名保密这一特性的需求，请在ISSUE中提出，以纳入开发计划。

Q：为什么我文件的sha256计算有差异？\
A：文本文件会有换行CRLF/LF的差异。rccc不会去进行相关的转换，而是直接计算文件的sha256。如果更换操作系统，或者是更改git的某项设置，就会出现不一致现象。但是，无需过度担心。因为在证明的时候，只需计算LF版本、CRLF版本的sha256，总有一个符合。
